[...truncated for brevity; full code from canvas will be inserted here...]