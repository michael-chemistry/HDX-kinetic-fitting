[full code inserted here - shortened for clarity]